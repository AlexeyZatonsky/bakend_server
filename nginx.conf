# /etc/nginx/nginx.conf
# ─────────────────────
events {}

http {
    # ────────── upstream'ы ──────────
    upstream backend {
        server app:1086;          # FastAPI-контейнер
    }

    upstream frontend {
        server frontend:80;       # Vite-React-контейнер
    }

    upstream minio_api {
        server minio:9000;        # S3-API
    }

    upstream minio_console {
        server minio:9001;        # Web-UI
    }

    # ────────── единый фронтовой сервер (порт 80) ──────────
    server {
        listen 80;
        server_name _;            # при желании укажи домен

        # ---------- SPA React ----------
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------- REST API FastAPI ----------
        location /api/ {
            proxy_pass http://backend/;      # слэш важен!
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
        }

        # ----- прямые ссылки на Swagger / Redoc -----
        location /api/docs/        { proxy_pass http://backend/docs/;  }
        location /api/redoc/       { proxy_pass http://backend/redoc/; }
        location /api/openapi.json {
            proxy_pass http://backend/openapi.json;
            add_header Content-Type application/json;
        }

        # ---------- MinIO через путь ----------
        location /minio/ {
            proxy_pass http://minio_console/;
            proxy_set_header Host $host;
        }

        # (опционально) прямой S3-эндпоинт
        location /s3/ {
            proxy_pass http://minio_api/;
            proxy_set_header Host $host;
        }
    }

    # ────────── отдельные порты для MinIO (оставляем, если нужны) ──────────
    server {
        listen 9000;
        location / {
            proxy_pass http://minio_api;
        }
    }

    server {
        listen 9001;
        location / {
            proxy_pass http://minio_console;
        }
    }
}
